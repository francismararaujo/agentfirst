name: Deploy Simples

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 373527788609
  ECR_REPOSITORY: agentfirst-gateway

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          npm install -g aws-cdk
          python -m pip install --upgrade pip
          pip install -r infra/cdk/requirements.txt
          
      - name: CDK Deploy
        env:
          ENVIRONMENT: production
        run: |
          echo "üöÄ Deploying Infrastructure & Code with CDK..."
          cd infra/cdk
          cdk bootstrap
          cdk deploy --all --require-approval never
      
      - name: Test deployment
        run: |
          echo "üß™ Testing endpoints..."
          sleep 10
          
          HEALTH_URL="https://ain6spik95.execute-api.us-east-1.amazonaws.com/prod/health"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Health check passed"
            
            # Test webhook
            echo "ü§ñ Testing Telegram webhook..."
            WEBHOOK_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "https://ain6spik95.execute-api.us-east-1.amazonaws.com/prod/webhook/telegram" \
              -H "Content-Type: application/json" \
              -d '{"message":{"chat":{"id":123},"text":"test","from":{"id":123}}}')
            
            if [ "$WEBHOOK_RESPONSE" = "200" ]; then
              echo "‚úÖ Webhook test passed"
            else
              echo "‚ö†Ô∏è Webhook test returned $WEBHOOK_RESPONSE"
            fi
          else
            echo "‚ùå Health check failed (HTTP $RESPONSE)"
            exit 1
          fi
